import numpy as np
from .RiskCohort import RiskCohort
from .RiskCluster import RiskCluster
from .Visualization import _FixSymbols
from .Visualization import RankedBox
from .Visualization import PairScatter
from .Visualization import KMPlots


def FeatureAnalysis(Model, Normalized, Raw, Symbols, Survival, Censored,
                    NPlot=10, NCluster=100, Tau=0.05, Path=None):
    """
    Generate visualizations of risk profiles. Backpropagation is used to

    Parameters:
    -----------
    Model : class
    Model generated by finetuning.

    Normalized : array_like
    Numpy array containing normalized feature values used in training /
    finetuning. These are used to examine associations between feature values
    and cluster assignments. Features are in columns and samples are in rows.

    Raw : array_like
    Numpy array containing raw, unnormalized feature values. These are used to
    examine associations between feature values and cluster assignments.
    Features are in columns and samples are in rows.

    Symbols : array_like
    List containing strings describing features. See Notes below for
    restrictions on symbol names.

    Survival : array_like
    Array containing death or last followup values.

    Censored : array_like
    Array containing vital status at last followup. 1 (alive) or 0 (deceased).

    NPlot : scalar
    Number of features to include when generating boxplot.
    Features are scored by absolute mean gradient and the highest N magnitude
    features will be used to generate the plot. Default value = 10.

    NCluster : scalar
    Number of features to include when generating cluster analysis.
    Features are scored by absolute mean gradient and the highest N magnitude
    features will be used to generate the plot. Default value = 100.

    Tau : scalar
    Threshold for statistical significance when examining cluster associations.

    Path : string
    Path to store .pdf versions of plots generated.
    """

    # wrap long symbols and remove leading and trailing whitespace
    Corrected, Types = _FixSymbols(Symbols)

    # generate risk derivative profiles for cohort
    print "Generting risk gradient profiles..."
    Gradients = RiskCohort(Model, Normalized)

    # re-order symbols, raw features, gradients by mean gradient value, trim
    Means = np.asarray(np.mean(Gradients, axis=0))
    Order = np.argsort(-np.abs(Means))
    cSymbols = [Corrected[i] for i in Order]
    cTypes = [Types[i] for i in Order]
    cRaw = Raw[:, Order]
    cGradients = Gradients[:, Order]

    # generate ranked box plot series
    print "Generating risk gradient boxplot..."
    RBFig = RankedBox(cGradients[:, 0:NPlot],
                      [cSymbols[i] for i in np.arange(NPlot)],
                      [cTypes[i] for i in np.arange(NPlot)],
                      XLabel='Model Features', YLabel='Risk Gradient')

    # generate paired scatter plot for gradients
    print "Generating paired scatter gradient plots..."
    PSGradFig = PairScatter(cGradients[:, 0:NPlot],
                            [cSymbols[i] for i in np.arange(NPlot)],
                            [cTypes[i] for i in np.arange(NPlot)])

    # generate paired scatter plot for features
    print "Generating paired scatter feature plots..."
    PSFeatFig = PairScatter(cRaw[:, 0:NPlot],
                            [cSymbols[i] for i in np.arange(NPlot)],
                            [cTypes[i] for i in np.arange(NPlot)])

    # generate cluster plot
    print "Generating cluster analysis..."
    CFig, Labels = RiskCluster(cGradients[:, 0:NCluster], cRaw[:, 0:NCluster],
                               [cSymbols[i] for i in np.arange(NCluster)],
                               [cTypes[i] for i in np.arange(NCluster)],
                               Tau)

    # generate Kaplan-Meier plots for individual features
    print "Generating Kaplan-Meier plots..."
    KMFigs = KMPlots(cGradients[:, 0:NPlot], cRaw[:, 0:NPlot],
                     [cSymbols[i] for i in np.arange(NPlot)],
                     [cTypes[i] for i in np.arange(NPlot)],
                     Survival, Censored)

    # save figures
    print "Saving figures..."
    if Path is not None:

        # save standard figures
        RBFig.savefig(Path + 'RankedBox.pdf')
        PSGradFig.savefig(Path + 'PairedScatter.Gradient.pdf')
        PSFeatFig.savefig(Path + 'PairedScatter.Feature.pdf')
        CFig.savefig(Path + 'Heatmap.pdf')
        for i, Figure in enumerate(KMFigs):
            Figure.savefig(Path + 'KM.' + Symbols[Order[i]].strip() + '.pdf')
